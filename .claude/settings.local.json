{
  "permissions": {
    "allow": [
      "Bash(cd:*)",
      "Bash(wc:*)",
      "Bash(python scripts/inject_keys.py:*)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/vite.config.ts << 'EOF'\nimport { defineConfig } from 'vite';\nimport react from '@vitejs/plugin-react';\n\n// https://vitejs.dev/config/\nexport default defineConfig\\({\n  plugins: [react\\(\\)],\n  server: {\n    port: 3000,\n    host: true,\n  },\n  build: {\n    outDir: 'dist',\n    sourcemap: false,\n    rollupOptions: {\n      output: {\n        manualChunks: {\n          'react-vendor': ['react', 'react-dom'],\n          'zmp-vendor': ['zmp-ui', 'zmp-sdk'],\n          'supabase-vendor': ['@supabase/supabase-js'],\n          'map-vendor': ['leaflet', 'react-leaflet'],\n        },\n      },\n    },\n    chunkSizeWarningLimit: 600,\n  },\n  optimizeDeps: {\n    include: ['react', 'react-dom', 'zmp-ui', 'recoil'],\n  },\n}\\);\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/.env.example << 'EOF'\n# SUPABASE CONFIG \\(Frontend\\)\nVITE_SUPABASE_URL=https://your-project.supabase.co\nVITE_SUPABASE_ANON_KEY=your-anon-key-here\n\n# CLOUDINARY CONFIG \\(Frontend - unsigned upload\\)\nVITE_CLOUDINARY_CLOUD_NAME=your-cloud-name\nVITE_CLOUDINARY_UPLOAD_PRESET=your-upload-preset\n\n# FIREBASE CONFIG \\(Add your Firebase config here\\)\n# VITE_FIREBASE_API_KEY=\n# VITE_FIREBASE_PROJECT_ID=\n# VITE_FIREBASE_MESSAGING_SENDER_ID=\n# VITE_FIREBASE_APP_ID=\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/config/cloudinary_config.json << 'EOF'\n{\n  \"upload_presets\": {\n    \"pet_diagnosis\": {\n      \"preset_name\": \"pet_family_unsigned\",\n      \"folder\": \"pet_diagnosis\",\n      \"tags\": [\"pet\", \"diagnosis\"],\n      \"transformation\": {\n        \"quality\": \"auto:good\",\n        \"fetch_format\": \"auto\",\n        \"width\": 800,\n        \"height\": 800,\n        \"crop\": \"limit\"\n      }\n    },\n    \"community_posts\": {\n      \"preset_name\": \"pet_family_unsigned\",\n      \"folder\": \"community\",\n      \"tags\": [\"community\", \"post\"],\n      \"transformation\": {\n        \"quality\": \"auto:good\",\n        \"fetch_format\": \"auto\",\n        \"width\": 600,\n        \"height\": 600,\n        \"crop\": \"limit\"\n      }\n    },\n    \"danger_zone\": {\n      \"preset_name\": \"pet_family_unsigned\",\n      \"folder\": \"danger_zone\",\n      \"tags\": [\"danger\", \"warning\"],\n      \"transformation\": {\n        \"quality\": \"auto:good\",\n        \"fetch_format\": \"auto\",\n        \"width\": 400,\n        \"height\": 400,\n        \"crop\": \"limit\"\n      }\n    }\n  },\n  \"tag_prefixes\": {\n    \"review\": \"review_\",\n    \"approved\": \"disease_\",\n    \"temp\": \"temp_\"\n  },\n  \"max_file_size_mb\": 10,\n  \"allowed_formats\": [\"jpg\", \"jpeg\", \"png\", \"webp\"]\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/config/osm_config.json << 'EOF'\n{\n  \"map_settings\": {\n    \"default_center\": {\n      \"hanoi\": {\n        \"lat\": 21.0285,\n        \"lon\": 105.8542,\n        \"zoom\": 12\n      },\n      \"hcmc\": {\n        \"lat\": 10.8231,\n        \"lon\": 106.6297,\n        \"zoom\": 12\n      }\n    },\n    \"tile_server\": \"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",\n    \"attribution\": \"&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors\",\n    \"max_zoom\": 19,\n    \"min_zoom\": 10\n  },\n  \"nominatim\": {\n    \"api_url\": \"https://nominatim.openstreetmap.org\",\n    \"rate_limit_ms\": 1000,\n    \"user_agent\": \"PetIsMyFamily/1.0\",\n    \"language\": \"vi\"\n  },\n  \"marker_icons\": {\n    \"poison\": {\n      \"icon\": \"‚ò†Ô∏è\",\n      \"color\": \"#FF0000\",\n      \"label\": \"B·∫£ ƒë·ªôc\"\n    },\n    \"thief\": {\n      \"icon\": \"üö®\",\n      \"color\": \"#FFA500\",\n      \"label\": \"Tr·ªôm ch√≥/m√®o\"\n    },\n    \"danger\": {\n      \"icon\": \"‚ö†Ô∏è\",\n      \"color\": \"#FFFF00\",\n      \"label\": \"Nguy hi·ªÉm kh√°c\"\n    }\n  },\n  \"alert_radius_km\": 1.0,\n  \"cluster_radius\": 50\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/supabase/migrations/001_initial_schema.sql << 'EOF'\n-- Pet Is My Family Database Schema\n-- Phase 1: Foundation Tables\n\n-- Enable UUID extension\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\n\n-- ============================================\n-- 1. PROFILES TABLE \\(User Management\\)\n-- ============================================\nCREATE TABLE IF NOT EXISTS profiles \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  zalo_id TEXT UNIQUE,\n  email TEXT,\n  name TEXT,\n  avatar TEXT,\n  xu_balance INTEGER DEFAULT 10,\n  ip_hash TEXT,\n  device_id TEXT,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for fast lookup\nCREATE INDEX idx_profiles_zalo_id ON profiles\\(zalo_id\\);\nCREATE INDEX idx_profiles_ip_hash ON profiles\\(ip_hash\\);\n\n-- ============================================\n-- 2. TRANSACTIONS TABLE \\(Xu System\\)\n-- ============================================\nCREATE TABLE IF NOT EXISTS transactions \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  user_id UUID REFERENCES profiles\\(id\\) ON DELETE CASCADE,\n  amount INTEGER NOT NULL,\n  money_amount INTEGER DEFAULT 0,\n  type TEXT NOT NULL CHECK \\(type IN \\('DEPOSIT', 'USAGE', 'BONUS', 'REFUND'\\)\\),\n  description TEXT,\n  status TEXT DEFAULT 'COMPLETED' CHECK \\(status IN \\('PENDING', 'COMPLETED', 'FAILED'\\)\\),\n  metadata JSONB,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for user transactions\nCREATE INDEX idx_transactions_user_id ON transactions\\(user_id\\);\nCREATE INDEX idx_transactions_status ON transactions\\(status\\);\nCREATE INDEX idx_transactions_created_at ON transactions\\(created_at DESC\\);\n\n-- ============================================\n-- 3. DISEASES TABLE \\(Disease Database\\)\n-- ============================================\nCREATE TABLE IF NOT EXISTS diseases \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  disease_id TEXT UNIQUE NOT NULL,\n  disease_name_vi TEXT NOT NULL,\n  disease_name_en TEXT,\n  keywords TEXT[],\n  symptoms_vi TEXT,\n  treatment_vi TEXT,\n  visual_desc TEXT,\n  prescription_otc TEXT,\n  prescription_rx TEXT,\n  questions JSONB,\n  cloudinary_links JSONB,\n  status TEXT DEFAULT 'active' CHECK \\(status IN \\('active', 'inactive', 'pending'\\)\\),\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for search\nCREATE INDEX idx_diseases_disease_id ON diseases\\(disease_id\\);\nCREATE INDEX idx_diseases_keywords ON diseases USING GIN\\(keywords\\);\nCREATE INDEX idx_diseases_status ON diseases\\(status\\);\n\n-- ============================================\n-- 4. DIAGNOSES TABLE \\(User Diagnosis History\\)\n-- ============================================\nCREATE TABLE IF NOT EXISTS diagnoses \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  user_id UUID REFERENCES profiles\\(id\\) ON DELETE CASCADE,\n  disease_id UUID REFERENCES diseases\\(id\\),\n  image_url TEXT,\n  description TEXT,\n  ai_result JSONB,\n  confidence_score DECIMAL\\(3,2\\),\n  questions_answers JSONB,\n  xu_spent INTEGER DEFAULT 1,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for user history\nCREATE INDEX idx_diagnoses_user_id ON diagnoses\\(user_id\\);\nCREATE INDEX idx_diagnoses_created_at ON diagnoses\\(created_at DESC\\);\n\n-- ============================================\n-- 5. DANGER_ZONES TABLE \\(Community Map\\)\n-- ============================================\nCREATE TABLE IF NOT EXISTS danger_zones \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  user_id UUID REFERENCES profiles\\(id\\) ON DELETE SET NULL,\n  lat DECIMAL\\(10, 8\\) NOT NULL,\n  lon DECIMAL\\(11, 8\\) NOT NULL,\n  type TEXT NOT NULL CHECK \\(type IN \\('poison', 'thief', 'danger'\\)\\),\n  description TEXT,\n  image_url TEXT,\n  status TEXT DEFAULT 'pending' CHECK \\(status IN \\('pending', 'approved', 'rejected'\\)\\),\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for geospatial queries\nCREATE INDEX idx_danger_zones_lat_lon ON danger_zones\\(lat, lon\\);\nCREATE INDEX idx_danger_zones_type ON danger_zones\\(type\\);\nCREATE INDEX idx_danger_zones_status ON danger_zones\\(status\\);\n\n-- ============================================\n-- 6. COMMUNITY_POSTS TABLE \\(Forum\\)\n-- ============================================\nCREATE TABLE IF NOT EXISTS community_posts \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  user_id UUID REFERENCES profiles\\(id\\) ON DELETE SET NULL,\n  title TEXT,\n  content TEXT NOT NULL,\n  image_url TEXT,\n  is_anonymous BOOLEAN DEFAULT false,\n  moderation_status TEXT DEFAULT 'pending' CHECK \\(moderation_status IN \\('pending', 'approved', 'rejected'\\)\\),\n  moderation_reason TEXT,\n  likes_count INTEGER DEFAULT 0,\n  comments_count INTEGER DEFAULT 0,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for feed\nCREATE INDEX idx_community_posts_created_at ON community_posts\\(created_at DESC\\);\nCREATE INDEX idx_community_posts_moderation_status ON community_posts\\(moderation_status\\);\n\n-- ============================================\n-- 7. COMMUNITY_COMMENTS TABLE\n-- ============================================\nCREATE TABLE IF NOT EXISTS community_comments \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  post_id UUID REFERENCES community_posts\\(id\\) ON DELETE CASCADE,\n  user_id UUID REFERENCES profiles\\(id\\) ON DELETE SET NULL,\n  content TEXT NOT NULL,\n  is_anonymous BOOLEAN DEFAULT false,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for post comments\nCREATE INDEX idx_community_comments_post_id ON community_comments\\(post_id\\);\nCREATE INDEX idx_community_comments_created_at ON community_comments\\(created_at DESC\\);\n\n-- ============================================\n-- 8. PET_PROFILES TABLE \\(Premium Feature\\)\n-- ============================================\nCREATE TABLE IF NOT EXISTS pet_profiles \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  user_id UUID REFERENCES profiles\\(id\\) ON DELETE CASCADE,\n  name TEXT NOT NULL,\n  species TEXT NOT NULL CHECK \\(species IN \\('dog', 'cat', 'other'\\)\\),\n  breed TEXT,\n  birth_date DATE,\n  weight DECIMAL\\(5,2\\),\n  avatar_url TEXT,\n  medical_history JSONB,\n  vaccination_records JSONB,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for user pets\nCREATE INDEX idx_pet_profiles_user_id ON pet_profiles\\(user_id\\);\n\n-- ============================================\n-- 9. VACCINATION_REMINDERS TABLE\n-- ============================================\nCREATE TABLE IF NOT EXISTS vaccination_reminders \\(\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4\\(\\),\n  pet_id UUID REFERENCES pet_profiles\\(id\\) ON DELETE CASCADE,\n  vaccine_name TEXT NOT NULL,\n  vaccine_name_vi TEXT,\n  scheduled_date DATE NOT NULL,\n  reminder_sent BOOLEAN DEFAULT false,\n  completed BOOLEAN DEFAULT false,\n  notes TEXT,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW\\(\\)\n\\);\n\n-- Index for reminders\nCREATE INDEX idx_vaccination_reminders_pet_id ON vaccination_reminders\\(pet_id\\);\nCREATE INDEX idx_vaccination_reminders_scheduled_date ON vaccination_reminders\\(scheduled_date\\);\nCREATE INDEX idx_vaccination_reminders_reminder_sent ON vaccination_reminders\\(reminder_sent\\);\n\n-- ============================================\n-- RPC FUNCTIONS\n-- ============================================\n\n-- Function: use_credits \\(Deduct xu safely\\)\nCREATE OR REPLACE FUNCTION use_credits\\(u_id UUID, cost INTEGER\\)\nRETURNS BOOLEAN AS $\nDECLARE\n  current_bal INTEGER;\nBEGIN\n  -- Lock row for update\n  SELECT xu_balance INTO current_bal \n  FROM profiles \n  WHERE id = u_id \n  FOR UPDATE;\n  \n  -- Check if enough balance\n  IF current_bal >= cost THEN\n    -- Deduct xu\n    UPDATE profiles \n    SET xu_balance = xu_balance - cost,\n        updated_at = NOW\\(\\)\n    WHERE id = u_id;\n    \n    -- Log transaction\n    INSERT INTO transactions \\(user_id, amount, type, description, status\\)\n    VALUES \\(u_id, -cost, 'USAGE', 'AI Diagnosis', 'COMPLETED'\\);\n    \n    RETURN true;\n  ELSE\n    RETURN false;\n  END IF;\nEND;\n$ LANGUAGE plpgsql SECURITY DEFINER;\n\n-- Function: add_credits \\(Add xu - admin only\\)\nCREATE OR REPLACE FUNCTION add_credits\\(u_id UUID, amount INTEGER, reason TEXT DEFAULT 'Manual Add'\\)\nRETURNS BOOLEAN AS $\nBEGIN\n  -- Add xu\n  UPDATE profiles \n  SET xu_balance = xu_balance + amount,\n      updated_at = NOW\\(\\)\n  WHERE id = u_id;\n  \n  -- Log transaction\n  INSERT INTO transactions \\(user_id, amount, type, description, status\\)\n  VALUES \\(u_id, amount, 'BONUS', reason, 'COMPLETED'\\);\n  \n  RETURN true;\nEND;\n$ LANGUAGE plpgsql SECURITY DEFINER;\n\n-- Function: get_nearby_dangers \\(Geospatial query\\)\nCREATE OR REPLACE FUNCTION get_nearby_dangers\\(\n  user_lat DECIMAL, \n  user_lon DECIMAL, \n  radius_km DECIMAL DEFAULT 1.0\n\\)\nRETURNS TABLE \\(\n  id UUID,\n  lat DECIMAL,\n  lon DECIMAL,\n  type TEXT,\n  description TEXT,\n  distance_km DECIMAL\n\\) AS $\nBEGIN\n  RETURN QUERY\n  SELECT \n    dz.id,\n    dz.lat,\n    dz.lon,\n    dz.type,\n    dz.description,\n    ROUND\\(\n      \\(6371 * acos\\(\n        cos\\(radians\\(user_lat\\)\\) * cos\\(radians\\(dz.lat\\)\\) * \n        cos\\(radians\\(dz.lon\\) - radians\\(user_lon\\)\\) + \n        sin\\(radians\\(user_lat\\)\\) * sin\\(radians\\(dz.lat\\)\\)\n      \\)\\)::NUMERIC, \n      2\n    \\) AS distance_km\n  FROM danger_zones dz\n  WHERE dz.status = 'approved'\n  AND \\(\n    6371 * acos\\(\n      cos\\(radians\\(user_lat\\)\\) * cos\\(radians\\(dz.lat\\)\\) * \n      cos\\(radians\\(dz.lon\\) - radians\\(user_lon\\)\\) + \n      sin\\(radians\\(user_lat\\)\\) * sin\\(radians\\(dz.lat\\)\\)\n    \\)\n  \\) <= radius_km\n  ORDER BY distance_km;\nEND;\n$ LANGUAGE plpgsql;\n\n-- ============================================\n-- ROW LEVEL SECURITY \\(RLS\\)\n-- ============================================\n\n-- Enable RLS on all tables\nALTER TABLE profiles ENABLE ROW LEVEL SECURITY;\nALTER TABLE transactions ENABLE ROW LEVEL SECURITY;\nALTER TABLE diagnoses ENABLE ROW LEVEL SECURITY;\nALTER TABLE danger_zones ENABLE ROW LEVEL SECURITY;\nALTER TABLE community_posts ENABLE ROW LEVEL SECURITY;\nALTER TABLE community_comments ENABLE ROW LEVEL SECURITY;\nALTER TABLE pet_profiles ENABLE ROW LEVEL SECURITY;\nALTER TABLE vaccination_reminders ENABLE ROW LEVEL SECURITY;\n\n-- Profiles: Users can read/update their own profile\nCREATE POLICY \"Users can view own profile\" ON profiles\n  FOR SELECT USING \\(auth.uid\\(\\) = id\\);\n\nCREATE POLICY \"Users can update own profile\" ON profiles\n  FOR UPDATE USING \\(auth.uid\\(\\) = id\\);\n\n-- Transactions: Users can view their own transactions\nCREATE POLICY \"Users can view own transactions\" ON transactions\n  FOR SELECT USING \\(auth.uid\\(\\) = user_id\\);\n\n-- Diagnoses: Users can view/insert their own diagnoses\nCREATE POLICY \"Users can view own diagnoses\" ON diagnoses\n  FOR SELECT USING \\(auth.uid\\(\\) = user_id\\);\n\nCREATE POLICY \"Users can insert own diagnoses\" ON diagnoses\n  FOR INSERT WITH CHECK \\(auth.uid\\(\\) = user_id\\);\n\n-- Danger Zones: Anyone can view approved, users can insert\nCREATE POLICY \"Anyone can view approved danger zones\" ON danger_zones\n  FOR SELECT USING \\(status = 'approved'\\);\n\nCREATE POLICY \"Authenticated users can insert danger zones\" ON danger_zones\n  FOR INSERT WITH CHECK \\(auth.uid\\(\\) = user_id\\);\n\n-- Community Posts: Anyone can view approved, users can insert\nCREATE POLICY \"Anyone can view approved posts\" ON community_posts\n  FOR SELECT USING \\(moderation_status = 'approved'\\);\n\nCREATE POLICY \"Authenticated users can insert posts\" ON community_posts\n  FOR INSERT WITH CHECK \\(auth.uid\\(\\) = user_id\\);\n\n-- Community Comments: Anyone can view, users can insert\nCREATE POLICY \"Anyone can view comments\" ON community_comments\n  FOR SELECT USING \\(true\\);\n\nCREATE POLICY \"Authenticated users can insert comments\" ON community_comments\n  FOR INSERT WITH CHECK \\(auth.uid\\(\\) = user_id\\);\n\n-- Pet Profiles: Users can manage their own pets\nCREATE POLICY \"Users can view own pets\" ON pet_profiles\n  FOR SELECT USING \\(auth.uid\\(\\) = user_id\\);\n\nCREATE POLICY \"Users can insert own pets\" ON pet_profiles\n  FOR INSERT WITH CHECK \\(auth.uid\\(\\) = user_id\\);\n\nCREATE POLICY \"Users can update own pets\" ON pet_profiles\n  FOR UPDATE USING \\(auth.uid\\(\\) = user_id\\);\n\nCREATE POLICY \"Users can delete own pets\" ON pet_profiles\n  FOR DELETE USING \\(auth.uid\\(\\) = user_id\\);\n\n-- Vaccination Reminders: Users can view reminders for their pets\nCREATE POLICY \"Users can view own pet reminders\" ON vaccination_reminders\n  FOR SELECT USING \\(\n    EXISTS \\(\n      SELECT 1 FROM pet_profiles \n      WHERE pet_profiles.id = vaccination_reminders.pet_id \n      AND pet_profiles.user_id = auth.uid\\(\\)\n    \\)\n  \\);\n\n-- Diseases: Public read access\nCREATE POLICY \"Anyone can view active diseases\" ON diseases\n  FOR SELECT USING \\(status = 'active'\\);\n\n-- ============================================\n-- TRIGGERS\n-- ============================================\n\n-- Auto-update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_updated_at_column\\(\\)\nRETURNS TRIGGER AS $\nBEGIN\n  NEW.updated_at = NOW\\(\\);\n  RETURN NEW;\nEND;\n$ LANGUAGE plpgsql;\n\nCREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON profiles\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column\\(\\);\n\nCREATE TRIGGER update_diseases_updated_at BEFORE UPDATE ON diseases\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column\\(\\);\n\nCREATE TRIGGER update_community_posts_updated_at BEFORE UPDATE ON community_posts\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column\\(\\);\n\nCREATE TRIGGER update_pet_profiles_updated_at BEFORE UPDATE ON pet_profiles\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column\\(\\);\n\n-- ============================================\n-- INITIAL DATA\n-- ============================================\n\n-- Insert sample admin user \\(optional\\)\n-- INSERT INTO profiles \\(id, email, name, xu_balance\\) \n-- VALUES \\('00000000-0000-0000-0000-000000000000', 'admin@petismyfamily.vn', 'Admin', 9999\\);\n\nCOMMENT ON TABLE profiles IS 'User profiles with xu balance and device tracking';\nCOMMENT ON TABLE transactions IS 'Xu transaction history for audit';\nCOMMENT ON TABLE diseases IS 'Disease database with AI-generated content';\nCOMMENT ON TABLE diagnoses IS 'User diagnosis history';\nCOMMENT ON TABLE danger_zones IS 'Community-reported danger zones \\(poison, thieves\\)';\nCOMMENT ON TABLE community_posts IS 'Community forum posts';\nCOMMENT ON TABLE pet_profiles IS 'User pet profiles \\(premium feature\\)';\nCOMMENT ON TABLE vaccination_reminders IS 'Vaccination schedule reminders';\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/admin_tool/utils/geocode_handler.py << 'GEOCODE_EOF'\nimport os\nimport time\nfrom geopy.geocoders import Nominatim\nfrom geopy.exc import GeocoderTimedOut, GeocoderServiceError\n\n# Initialize geocoder\ngeolocator = Nominatim\\(user_agent=\"PetIsMyFamily/1.0\"\\)\n\ndef geocode_address\\(address, language='vi'\\):\n    \"\"\"\n    Geocode an address to lat/lon coordinates.\n    Returns \\(lat, lon\\) or \\(None, None\\) if failed.\n    \"\"\"\n    try:\n        location = geolocator.geocode\\(address, language=language, timeout=10\\)\n        if location:\n            return location.latitude, location.longitude\n        return None, None\n    except \\(GeocoderTimedOut, GeocoderServiceError\\) as e:\n        print\\(f\"Geocoding error for '{address}': {e}\"\\)\n        return None, None\n\ndef reverse_geocode\\(lat, lon, language='vi'\\):\n    \"\"\"\n    Reverse geocode lat/lon to address.\n    Returns address string or None if failed.\n    \"\"\"\n    try:\n        location = geolocator.reverse\\(f\"{lat}, {lon}\", language=language, timeout=10\\)\n        if location:\n            return location.address\n        return None\n    except \\(GeocoderTimedOut, GeocoderServiceError\\) as e:\n        print\\(f\"Reverse geocoding error for \\({lat}, {lon}\\): {e}\"\\)\n        return None\n\ndef seed_hanoi_locations\\(\\):\n    \"\"\"\n    Returns a list of seed danger zone locations in Hanoi.\n    Format: [\\(lat, lon, type, description\\), ...]\n    \"\"\"\n    locations = [\n        \\(21.0285, 105.8542, 'poison', 'H·ªì Ho√†n Ki·∫øm - B√°o c√°o b·∫£ ƒë·ªôc g·∫ßn khu v·ª±c'\\),\n        \\(21.0245, 105.8412, 'thief', 'Ph·ªë H√†ng B·∫°c - C·∫£nh b√°o tr·ªôm ch√≥'\\),\n        \\(21.0368, 105.8345, 'poison', 'C√¥ng vi√™n Th·ªëng Nh·∫•t - Ph√°t hi·ªán b·∫£ ƒë·ªôc'\\),\n        \\(21.0278, 105.8519, 'danger', 'Ph·ªë Tr√†ng Ti·ªÅn - Khu v·ª±c nguy hi·ªÉm'\\),\n        \\(21.0453, 105.8242, 'thief', 'Ch·ª£ ƒê·ªìng Xu√¢n - C·∫£nh b√°o tr·ªôm m√®o'\\),\n    ]\n    return locations\n\ndef seed_hcmc_locations\\(\\):\n    \"\"\"\n    Returns a list of seed danger zone locations in Ho Chi Minh City.\n    Format: [\\(lat, lon, type, description\\), ...]\n    \"\"\"\n    locations = [\n        \\(10.8231, 106.6297, 'poison', 'C√¥ng vi√™n Tao ƒê√†n - B√°o c√°o b·∫£ ƒë·ªôc'\\),\n        \\(10.7769, 106.7009, 'thief', 'Qu·∫≠n 1 - C·∫£nh b√°o tr·ªôm ch√≥'\\),\n        \\(10.7626, 106.6826, 'poison', 'B·∫øn Th√†nh - Ph√°t hi·ªán b·∫£ ƒë·ªôc'\\),\n        \\(10.8142, 106.6438, 'danger', 'Qu·∫≠n 3 - Khu v·ª±c nguy hi·ªÉm'\\),\n        \\(10.7546, 106.6622, 'thief', 'Qu·∫≠n 5 - C·∫£nh b√°o tr·ªôm m√®o'\\),\n    ]\n    return locations\n\ndef get_distance_km\\(lat1, lon1, lat2, lon2\\):\n    \"\"\"\n    Calculate distance between two points using Haversine formula.\n    Returns distance in kilometers.\n    \"\"\"\n    from math import radians, cos, sin, asin, sqrt\n\n    lat1, lon1, lat2, lon2 = map\\(radians, [lat1, lon1, lat2, lon2]\\)\n    dlat = lat2 - lat1\n    dlon = lon2 - lon1\n    a = sin\\(dlat/2\\)**2 + cos\\(lat1\\) * cos\\(lat2\\) * sin\\(dlon/2\\)**2\n    c = 2 * asin\\(sqrt\\(a\\)\\)\n    r = 6371\n    return c * r\nGEOCODE_EOF)",
      "Bash(echo:*)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/models/User.js << 'EOF'\n/**\n * User Model\n */\nexport class User {\n  constructor\\(data = {}\\) {\n    this.id = data.id || '';\n    this.zaloId = data.zaloId || data.zalo_id || '';\n    this.name = data.name || 'Ng∆∞·ªùi d√πng';\n    this.avatar = data.avatar || '';\n    this.email = data.email || '';\n    this.xuBalance = data.xuBalance || data.xu_balance || 0;\n    this.ipHash = data.ipHash || data.ip_hash || '';\n    this.deviceId = data.deviceId || data.device_id || '';\n    this.createdAt = data.createdAt || data.created_at || new Date\\(\\);\n  }\n\n  toJSON\\(\\) {\n    return {\n      id: this.id,\n      zalo_id: this.zaloId,\n      name: this.name,\n      avatar: this.avatar,\n      email: this.email,\n      xu_balance: this.xuBalance,\n      ip_hash: this.ipHash,\n      device_id: this.deviceId,\n      created_at: this.createdAt,\n    };\n  }\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/models/Disease.js << 'EOF'\n/**\n * Disease Model\n */\nexport class Disease {\n  constructor\\(data = {}\\) {\n    this.id = data.id || '';\n    this.diseaseId = data.diseaseId || data.disease_id || '';\n    this.diseaseNameVi = data.diseaseNameVi || data.disease_name_vi || '';\n    this.diseaseNameEn = data.diseaseNameEn || data.disease_name_en || '';\n    this.keywords = data.keywords || [];\n    this.symptomsVi = data.symptomsVi || data.symptoms_vi || '';\n    this.treatmentVi = data.treatmentVi || data.treatment_vi || '';\n    this.visualDesc = data.visualDesc || data.visual_desc || '';\n    this.prescriptionOtc = data.prescriptionOtc || data.prescription_otc || '';\n    this.prescriptionRx = data.prescriptionRx || data.prescription_rx || '';\n    this.questions = data.questions || [];\n    this.cloudinaryLinks = data.cloudinaryLinks || data.cloudinary_links || [];\n    this.status = data.status || 'active';\n  }\n\n  toJSON\\(\\) {\n    return {\n      id: this.id,\n      disease_id: this.diseaseId,\n      disease_name_vi: this.diseaseNameVi,\n      disease_name_en: this.diseaseNameEn,\n      keywords: this.keywords,\n      symptoms_vi: this.symptomsVi,\n      treatment_vi: this.treatmentVi,\n      visual_desc: this.visualDesc,\n      prescription_otc: this.prescriptionOtc,\n      prescription_rx: this.prescriptionRx,\n      questions: this.questions,\n      cloudinary_links: this.cloudinaryLinks,\n      status: this.status,\n    };\n  }\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/models/Transaction.js << 'EOF'\n/**\n * Transaction Model\n */\nexport class Transaction {\n  constructor\\(data = {}\\) {\n    this.id = data.id || '';\n    this.userId = data.userId || data.user_id || '';\n    this.amount = data.amount || 0;\n    this.moneyAmount = data.moneyAmount || data.money_amount || 0;\n    this.type = data.type || 'USAGE'; // DEPOSIT, USAGE, BONUS, REFUND\n    this.description = data.description || '';\n    this.status = data.status || 'COMPLETED'; // PENDING, COMPLETED, FAILED\n    this.metadata = data.metadata || {};\n    this.createdAt = data.createdAt || data.created_at || new Date\\(\\);\n  }\n\n  toJSON\\(\\) {\n    return {\n      id: this.id,\n      user_id: this.userId,\n      amount: this.amount,\n      money_amount: this.moneyAmount,\n      type: this.type,\n      description: this.description,\n      status: this.status,\n      metadata: this.metadata,\n      created_at: this.createdAt,\n    };\n  }\n\n  isDeposit\\(\\) {\n    return this.type === 'DEPOSIT';\n  }\n\n  isUsage\\(\\) {\n    return this.type === 'USAGE';\n  }\n\n  isBonus\\(\\) {\n    return this.type === 'BONUS';\n  }\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/models/PetProfile.js << 'EOF'\n/**\n * Pet Profile Model\n */\nexport class PetProfile {\n  constructor\\(data = {}\\) {\n    this.id = data.id || '';\n    this.userId = data.userId || data.user_id || '';\n    this.name = data.name || '';\n    this.species = data.species || 'dog'; // dog, cat, other\n    this.breed = data.breed || '';\n    this.birthDate = data.birthDate || data.birth_date || null;\n    this.weight = data.weight || 0;\n    this.avatarUrl = data.avatarUrl || data.avatar_url || '';\n    this.medicalHistory = data.medicalHistory || data.medical_history || [];\n    this.vaccinationRecords = data.vaccinationRecords || data.vaccination_records || [];\n    this.createdAt = data.createdAt || data.created_at || new Date\\(\\);\n  }\n\n  getAge\\(\\) {\n    if \\(!this.birthDate\\) return null;\n    const today = new Date\\(\\);\n    const birth = new Date\\(this.birthDate\\);\n    const ageInMonths = \\(today.getFullYear\\(\\) - birth.getFullYear\\(\\)\\) * 12 + \n                        \\(today.getMonth\\(\\) - birth.getMonth\\(\\)\\);\n    return ageInMonths;\n  }\n\n  getAgeWeeks\\(\\) {\n    const ageInMonths = this.getAge\\(\\);\n    return ageInMonths ? Math.floor\\(ageInMonths * 4.33\\) : null;\n  }\n\n  toJSON\\(\\) {\n    return {\n      id: this.id,\n      user_id: this.userId,\n      name: this.name,\n      species: this.species,\n      breed: this.breed,\n      birth_date: this.birthDate,\n      weight: this.weight,\n      avatar_url: this.avatarUrl,\n      medical_history: this.medicalHistory,\n      vaccination_records: this.vaccinationRecords,\n      created_at: this.createdAt,\n    };\n  }\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/models/DangerZone.js << 'EOF'\n/**\n * Danger Zone Model\n */\nexport class DangerZone {\n  constructor\\(data = {}\\) {\n    this.id = data.id || '';\n    this.userId = data.userId || data.user_id || '';\n    this.lat = data.lat || 0;\n    this.lon = data.lon || 0;\n    this.type = data.type || 'danger'; // poison, thief, danger\n    this.description = data.description || '';\n    this.imageUrl = data.imageUrl || data.image_url || '';\n    this.status = data.status || 'pending'; // pending, approved, rejected\n    this.createdAt = data.createdAt || data.created_at || new Date\\(\\);\n  }\n\n  getTypeLabel\\(\\) {\n    const labels = {\n      poison: 'B·∫£ ƒë·ªôc',\n      thief: 'Tr·ªôm ch√≥/m√®o',\n      danger: 'Nguy hi·ªÉm kh√°c',\n    };\n    return labels[this.type] || 'Kh√¥ng x√°c ƒë·ªãnh';\n  }\n\n  getTypeIcon\\(\\) {\n    const icons = {\n      poison: '‚ò†Ô∏è',\n      thief: 'üö®',\n      danger: '‚ö†Ô∏è',\n    };\n    return icons[this.type] || '‚ö†Ô∏è';\n  }\n\n  getTypeColor\\(\\) {\n    const colors = {\n      poison: '#FF0000',\n      thief: '#FFA500',\n      danger: '#FFFF00',\n    };\n    return colors[this.type] || '#FFFF00';\n  }\n\n  toJSON\\(\\) {\n    return {\n      id: this.id,\n      user_id: this.userId,\n      lat: this.lat,\n      lon: this.lon,\n      type: this.type,\n      description: this.description,\n      image_url: this.imageUrl,\n      status: this.status,\n      created_at: this.createdAt,\n    };\n  }\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/models/FoodItem.js << 'EOF'\n/**\n * Food Item Model\n */\nexport class FoodItem {\n  constructor\\(data = {}\\) {\n    this.name = data.name || '';\n    this.nameEn = data.nameEn || data.name_en || '';\n    this.riskLevel = data.riskLevel || data.risk_level || 'low'; // high, medium, low\n    this.color = data.color || '#00FF00';\n    this.species = data.species || [];\n    this.description = data.description || '';\n    this.source = data.source || '';\n  }\n\n  getRiskLabel\\(\\) {\n    const labels = {\n      high: 'Nguy hi·ªÉm',\n      medium: 'C·∫©n th·∫≠n',\n      low: 'An to√†n',\n    };\n    return labels[this.riskLevel] || 'Kh√¥ng x√°c ƒë·ªãnh';\n  }\n\n  getRiskAction\\(\\) {\n    const actions = {\n      high: 'Tr√°nh ho√†n to√†n',\n      medium: 'H·∫°n ch·∫ø ho·∫∑c tr√°nh',\n      low: 'OK v·ªõi l∆∞·ª£ng v·ª´a ph·∫£i',\n    };\n    return actions[this.riskLevel] || '';\n  }\n\n  isSafeFor\\(species\\) {\n    return this.species.includes\\(species\\);\n  }\n}\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/models/index.js << 'EOF'\nexport { Disease } from './Disease';\nexport { User } from './User';\nexport { Transaction } from './Transaction';\nexport { PetProfile } from './PetProfile';\nexport { DangerZone } from './DangerZone';\nexport { FoodItem } from './FoodItem';\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/services/useXu.js << 'EOF'\nimport { useState, useEffect } from 'react';\nimport { supabase } from '../supabase';\nimport { useRecoilState } from 'recoil';\nimport { xuBalanceState, userState } from '../state';\n\nexport const useXu = \\(\\) => {\n  const [balance, setBalance] = useRecoilState\\(xuBalanceState\\);\n  const [user] = useRecoilState\\(userState\\);\n  const [loading, setLoading] = useState\\(false\\);\n  const [error, setError] = useState\\(null\\);\n\n  // Fetch current balance\n  const fetchBalance = async \\(\\) => {\n    if \\(!user.id\\) return;\n\n    try {\n      const { data, error } = await supabase\n        .from\\('profiles'\\)\n        .select\\('xu_balance'\\)\n        .eq\\('id', user.id\\)\n        .single\\(\\);\n\n      if \\(error\\) throw error;\n      if \\(data\\) {\n        setBalance\\(data.xu_balance\\);\n      }\n    } catch \\(err\\) {\n      console.error\\('Error fetching balance:', err\\);\n      setError\\(err.message\\);\n    }\n  };\n\n  // Deduct xu using RPC function \\(secure\\)\n  const deductXu = async \\(cost, description = 'AI Diagnosis'\\) => {\n    if \\(!user.id\\) {\n      setError\\('User not logged in'\\);\n      return false;\n    }\n\n    if \\(balance < cost\\) {\n      setError\\('Insufficient xu balance'\\);\n      return false;\n    }\n\n    setLoading\\(true\\);\n    setError\\(null\\);\n\n    try {\n      // Call RPC function\n      const { data, error } = await supabase.rpc\\('use_credits', {\n        u_id: user.id,\n        cost: cost,\n      }\\);\n\n      if \\(error\\) throw error;\n\n      if \\(data === true\\) {\n        // Update local state optimistically\n        setBalance\\(\\(prev\\) => prev - cost\\);\n        return true;\n      } else {\n        setError\\('Failed to deduct xu'\\);\n        return false;\n      }\n    } catch \\(err\\) {\n      console.error\\('Error deducting xu:', err\\);\n      setError\\(err.message\\);\n      return false;\n    } finally {\n      setLoading\\(false\\);\n    }\n  };\n\n  // Check if user has enough xu\n  const hasEnoughXu = \\(cost\\) => {\n    return balance >= cost;\n  };\n\n  // Get transaction history\n  const getTransactionHistory = async \\(limit = 10\\) => {\n    if \\(!user.id\\) return [];\n\n    try {\n      const { data, error } = await supabase\n        .from\\('transactions'\\)\n        .select\\('*'\\)\n        .eq\\('user_id', user.id\\)\n        .order\\('created_at', { ascending: false }\\)\n        .limit\\(limit\\);\n\n      if \\(error\\) throw error;\n      return data || [];\n    } catch \\(err\\) {\n      console.error\\('Error fetching transactions:', err\\);\n      return [];\n    }\n  };\n\n  // Subscribe to balance changes \\(realtime\\)\n  useEffect\\(\\(\\) => {\n    if \\(!user.id\\) return;\n\n    const channel = supabase\n      .channel\\('xu_balance_changes'\\)\n      .on\\(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'profiles',\n          filter: `id=eq.${user.id}`,\n        },\n        \\(payload\\) => {\n          if \\(payload.new.xu_balance !== undefined\\) {\n            setBalance\\(payload.new.xu_balance\\);\n          }\n        }\n      \\)\n      .subscribe\\(\\);\n\n    return \\(\\) => {\n      supabase.removeChannel\\(channel\\);\n    };\n  }, [user.id, setBalance]\\);\n\n  return {\n    balance,\n    loading,\n    error,\n    deductXu,\n    hasEnoughXu,\n    fetchBalance,\n    getTransactionHistory,\n  };\n};\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/components/VacxinReminder.jsx << 'EOF'\nimport React, { useState } from 'react';\nimport { Box, Select, Text, Button } from 'zmp-ui';\nimport vacxinData from '../../../config/vacxin_schedule.json';\n\nconst { Option } = Select;\n\nconst VacxinReminder = \\(\\) => {\n  const [species, setSpecies] = useState\\('dog'\\);\n  const [ageWeeks, setAgeWeeks] = useState\\(''\\);\n  const [reminders, setReminders] = useState\\([]\\);\n\n  const handleCalculate = \\(\\) => {\n    if \\(!ageWeeks\\) return;\n\n    const age = parseInt\\(ageWeeks\\);\n    const schedule = vacxinData[species]?.schedule || [];\n\n    // Find upcoming vaccines\n    const upcoming = schedule.filter\\(\\(vaccine\\) => {\n      return vaccine.age_weeks >= age && vaccine.age_weeks <= age + 8;\n    }\\);\n\n    setReminders\\(upcoming\\);\n  };\n\n  const getDaysUntil = \\(targetWeeks\\) => {\n    const currentWeeks = parseInt\\(ageWeeks\\) || 0;\n    const weeksUntil = targetWeeks - currentWeeks;\n    return Math.max\\(0, weeksUntil * 7\\);\n  };\n\n  return \\(\n    <Box className=\"bg-white rounded-xl shadow-sm p-4 mb-4\">\n      <Text.Title size=\"small\" className=\"mb-3\">\n        üíâ L·ªãch ti√™m vacxin\n      </Text.Title>\n\n      <Box className=\"grid grid-cols-2 gap-2 mb-3\">\n        <Box>\n          <Text className=\"text-xs text-gray-600 mb-1\">Lo√†i</Text>\n          <Select\n            value={species}\n            onChange={\\(value\\) => setSpecies\\(value\\)}\n            placeholder=\"Ch·ªçn lo√†i\"\n          >\n            <Option value=\"dog\" title=\"Ch√≥\" />\n            <Option value=\"cat\" title=\"M√®o\" />\n          </Select>\n        </Box>\n\n        <Box>\n          <Text className=\"text-xs text-gray-600 mb-1\">Tu·ªïi \\(tu·∫ßn\\)</Text>\n          <input\n            type=\"number\"\n            placeholder=\"V√≠ d·ª•: 6\"\n            value={ageWeeks}\n            onChange={\\(e\\) => setAgeWeeks\\(e.target.value\\)}\n            className=\"w-full px-3 py-2 border border-gray-300 rounded\"\n            min=\"0\"\n            max=\"260\"\n          />\n        </Box>\n      </Box>\n\n      <Button\n        size=\"small\"\n        fullWidth\n        onClick={handleCalculate}\n        disabled={!ageWeeks}\n      >\n        Xem l·ªãch ti√™m\n      </Button>\n\n      {reminders.length > 0 && \\(\n        <Box className=\"mt-4 space-y-2\">\n          <Text className=\"font-bold text-sm mb-2\">\n            üìÖ L·ªãch ti√™m s·∫Øp t·ªõi:\n          </Text>\n\n          {reminders.map\\(\\(vaccine, index\\) => \\(\n            <Box\n              key={index}\n              className=\"border border-blue-200 bg-blue-50 rounded-lg p-3\"\n            >\n              <Box className=\"flex justify-between items-start mb-1\">\n                <Text className=\"font-bold text-sm\">\n                  {vaccine.vaccine_name_vi}\n                </Text>\n                <Box className=\"bg-blue-500 text-white text-xs px-2 py-1 rounded\">\n                  {vaccine.age_weeks} tu·∫ßn\n                </Box>\n              </Box>\n\n              <Text className=\"text-xs text-gray-600 mb-2\">\n                {vaccine.description}\n              </Text>\n\n              <Box className=\"flex items-center justify-between\">\n                <Text className=\"text-xs text-gray-500\">\n                  {vaccine.required ? '‚ö†Ô∏è B·∫Øt bu·ªôc' : 'üí° T√πy ch·ªçn'}\n                </Text>\n                <Text className=\"text-xs font-bold text-blue-600\">\n                  C√≤n {getDaysUntil\\(vaccine.age_weeks\\)} ng√†y\n                </Text>\n              </Box>\n            </Box>\n          \\)\\)}\n\n          <Text className=\"text-xs text-gray-500 mt-3\">\n            üí° M·∫πo: ƒê·∫∑t l·ªãch h·∫πn v·ªõi b√°c sƒ© th√∫ y tr∆∞·ªõc {reminders[0]?.reminder_days_before || 7} ng√†y\n          </Text>\n        </Box>\n      \\)}\n\n      {reminders.length === 0 && ageWeeks && \\(\n        <Box className=\"mt-4 text-center p-3 bg-gray-100 rounded\">\n          <Text className=\"text-sm text-gray-600\">\n            Kh√¥ng c√≥ l·ªãch ti√™m trong 8 tu·∫ßn t·ªõi.\n            <br />\n            H√£y ki·ªÉm tra l·∫°i tu·ªïi ho·∫∑c xem l·ªãch ƒë·∫ßy ƒë·ªß.\n          </Text>\n        </Box>\n      \\)}\n\n      {!ageWeeks && \\(\n        <Text className=\"text-xs text-gray-400 text-center mt-3\">\n          üí° Nh·∫≠p tu·ªïi th√∫ c∆∞ng ƒë·ªÉ xem l·ªãch ti√™m ph√π h·ª£p\n        </Text>\n      \\)}\n    </Box>\n  \\);\n};\n\nexport default VacxinReminder;\nEOF)",
      "Bash(ls:*)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/services/useCommunity.js << 'EOF'\nimport { useState, useEffect } from 'react';\nimport { supabase } from '../supabase';\nimport { useRecoilValue } from 'recoil';\nimport { userState } from '../state';\n\nexport const useCommunity = \\(\\) => {\n  const [posts, setPosts] = useState\\([]\\);\n  const [loading, setLoading] = useState\\(false\\);\n  const [error, setError] = useState\\(null\\);\n  const user = useRecoilValue\\(userState\\);\n\n  // Fetch approved posts\n  const fetchPosts = async \\(limit = 20\\) => {\n    setLoading\\(true\\);\n    setError\\(null\\);\n\n    try {\n      const { data, error } = await supabase\n        .from\\('community_posts'\\)\n        .select\\('*, profiles\\(name, avatar\\)'\\)\n        .eq\\('moderation_status', 'approved'\\)\n        .order\\('created_at', { ascending: false }\\)\n        .limit\\(limit\\);\n\n      if \\(error\\) throw error;\n      setPosts\\(data || []\\);\n    } catch \\(err\\) {\n      console.error\\('Error fetching posts:', err\\);\n      setError\\(err.message\\);\n    } finally {\n      setLoading\\(false\\);\n    }\n  };\n\n  // Create new post\n  const createPost = async \\(postData\\) => {\n    if \\(!user.id\\) {\n      setError\\('User not logged in'\\);\n      return null;\n    }\n\n    setLoading\\(true\\);\n    setError\\(null\\);\n\n    try {\n      // Moderate content with Groq \\(simple spam detection\\)\n      const isSpam = await moderateContent\\(postData.content\\);\n      \n      const { data, error } = await supabase\n        .from\\('community_posts'\\)\n        .insert\\({\n          user_id: user.id,\n          title: postData.title || '',\n          content: postData.content,\n          image_url: postData.image_url || null,\n          is_anonymous: postData.is_anonymous || false,\n          moderation_status: isSpam ? 'rejected' : 'pending',\n          moderation_reason: isSpam ? 'Detected as spam' : null,\n        }\\)\n        .select\\(\\)\n        .single\\(\\);\n\n      if \\(error\\) throw error;\n      \n      // If not spam, add to local state optimistically\n      if \\(!isSpam\\) {\n        setPosts\\(\\(prev\\) => [data, ...prev]\\);\n      }\n      \n      return data;\n    } catch \\(err\\) {\n      console.error\\('Error creating post:', err\\);\n      setError\\(err.message\\);\n      return null;\n    } finally {\n      setLoading\\(false\\);\n    }\n  };\n\n  // Moderate content using simple keyword detection\n  const moderateContent = async \\(content\\) => {\n    // Simple spam keywords \\(in production, use Groq API\\)\n    const spamKeywords = [\n      'mua b√°n',\n      'qu·∫£ng c√°o',\n      'li√™n h·ªá zalo',\n      'inbox',\n      'gi√° r·∫ª',\n      'khuy·∫øn m√£i',\n      'sale',\n    ];\n\n    const lowerContent = content.toLowerCase\\(\\);\n    return spamKeywords.some\\(\\(keyword\\) => lowerContent.includes\\(keyword\\)\\);\n  };\n\n  // Get comments for a post\n  const getComments = async \\(postId\\) => {\n    try {\n      const { data, error } = await supabase\n        .from\\('community_comments'\\)\n        .select\\('*, profiles\\(name, avatar\\)'\\)\n        .eq\\('post_id', postId\\)\n        .order\\('created_at', { ascending: true }\\);\n\n      if \\(error\\) throw error;\n      return data || [];\n    } catch \\(err\\) {\n      console.error\\('Error fetching comments:', err\\);\n      return [];\n    }\n  };\n\n  // Add comment\n  const addComment = async \\(postId, content, isAnonymous = false\\) => {\n    if \\(!user.id\\) {\n      setError\\('User not logged in'\\);\n      return null;\n    }\n\n    try {\n      const { data, error } = await supabase\n        .from\\('community_comments'\\)\n        .insert\\({\n          post_id: postId,\n          user_id: user.id,\n          content: content,\n          is_anonymous: isAnonymous,\n        }\\)\n        .select\\(\\)\n        .single\\(\\);\n\n      if \\(error\\) throw error;\n\n      // Update comment count\n      await supabase.rpc\\('increment_comment_count', { post_id: postId }\\);\n\n      return data;\n    } catch \\(err\\) {\n      console.error\\('Error adding comment:', err\\);\n      setError\\(err.message\\);\n      return null;\n    }\n  };\n\n  // Like post\n  const likePost = async \\(postId\\) => {\n    try {\n      // Increment likes count\n      const { error } = await supabase\n        .from\\('community_posts'\\)\n        .update\\({ likes_count: supabase.raw\\('likes_count + 1'\\) }\\)\n        .eq\\('id', postId\\);\n\n      if \\(error\\) throw error;\n\n      // Update local state\n      setPosts\\(\\(prev\\) =>\n        prev.map\\(\\(post\\) =>\n          post.id === postId\n            ? { ...post, likes_count: post.likes_count + 1 }\n            : post\n        \\)\n      \\);\n    } catch \\(err\\) {\n      console.error\\('Error liking post:', err\\);\n    }\n  };\n\n  // Subscribe to realtime updates\n  useEffect\\(\\(\\) => {\n    const channel = supabase\n      .channel\\('community_posts_changes'\\)\n      .on\\(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'community_posts',\n          filter: 'moderation_status=eq.approved',\n        },\n        \\(payload\\) => {\n          setPosts\\(\\(prev\\) => [payload.new, ...prev]\\);\n        }\n      \\)\n      .on\\(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'community_posts',\n        },\n        \\(payload\\) => {\n          setPosts\\(\\(prev\\) =>\n            prev.map\\(\\(post\\) =>\n              post.id === payload.new.id ? payload.new : post\n            \\)\n          \\);\n        }\n      \\)\n      .subscribe\\(\\);\n\n    return \\(\\) => {\n      supabase.removeChannel\\(channel\\);\n    };\n  }, []\\);\n\n  return {\n    posts,\n    loading,\n    error,\n    fetchPosts,\n    createPost,\n    getComments,\n    addComment,\n    likePost,\n  };\n};\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/services/useMap.js << 'EOF'\nimport { useState, useEffect } from 'react';\nimport { supabase } from '../supabase';\nimport { useRecoilValue } from 'recoil';\nimport { userState } from '../state';\n\nexport const useMap = \\(\\) => {\n  const [dangerZones, setDangerZones] = useState\\([]\\);\n  const [userLocation, setUserLocation] = useState\\(null\\);\n  const [loading, setLoading] = useState\\(false\\);\n  const [error, setError] = useState\\(null\\);\n  const user = useRecoilValue\\(userState\\);\n\n  // Fetch approved danger zones\n  const fetchDangerZones = async \\(\\) => {\n    setLoading\\(true\\);\n    setError\\(null\\);\n\n    try {\n      const { data, error } = await supabase\n        .from\\('danger_zones'\\)\n        .select\\('*'\\)\n        .eq\\('status', 'approved'\\)\n        .order\\('created_at', { ascending: false }\\);\n\n      if \\(error\\) throw error;\n      setDangerZones\\(data || []\\);\n    } catch \\(err\\) {\n      console.error\\('Error fetching danger zones:', err\\);\n      setError\\(err.message\\);\n    } finally {\n      setLoading\\(false\\);\n    }\n  };\n\n  // Get nearby danger zones using RPC\n  const getNearbyDangers = async \\(lat, lon, radiusKm = 1.0\\) => {\n    try {\n      const { data, error } = await supabase.rpc\\('get_nearby_dangers', {\n        user_lat: lat,\n        user_lon: lon,\n        radius_km: radiusKm,\n      }\\);\n\n      if \\(error\\) throw error;\n      return data || [];\n    } catch \\(err\\) {\n      console.error\\('Error getting nearby dangers:', err\\);\n      return [];\n    }\n  };\n\n  // Add new danger zone\n  const addDangerZone = async \\(zoneData\\) => {\n    if \\(!user.id\\) {\n      setError\\('User not logged in'\\);\n      return null;\n    }\n\n    setLoading\\(true\\);\n    setError\\(null\\);\n\n    try {\n      const { data, error } = await supabase\n        .from\\('danger_zones'\\)\n        .insert\\({\n          user_id: user.id,\n          lat: zoneData.lat,\n          lon: zoneData.lon,\n          type: zoneData.type, // poison, thief, danger\n          description: zoneData.description,\n          image_url: zoneData.image_url || null,\n          status: 'pending', // Needs admin approval\n        }\\)\n        .select\\(\\)\n        .single\\(\\);\n\n      if \\(error\\) throw error;\n      return data;\n    } catch \\(err\\) {\n      console.error\\('Error adding danger zone:', err\\);\n      setError\\(err.message\\);\n      return null;\n    } finally {\n      setLoading\\(false\\);\n    }\n  };\n\n  // Get user's current location\n  const getCurrentLocation = \\(\\) => {\n    return new Promise\\(\\(resolve, reject\\) => {\n      if \\(!navigator.geolocation\\) {\n        reject\\(new Error\\('Geolocation not supported'\\)\\);\n        return;\n      }\n\n      navigator.geolocation.getCurrentPosition\\(\n        \\(position\\) => {\n          const location = {\n            lat: position.coords.latitude,\n            lon: position.coords.longitude,\n          };\n          setUserLocation\\(location\\);\n          resolve\\(location\\);\n        },\n        \\(error\\) => {\n          reject\\(error\\);\n        },\n        {\n          enableHighAccuracy: true,\n          timeout: 10000,\n          maximumAge: 0,\n        }\n      \\);\n    }\\);\n  };\n\n  // Reverse geocode \\(lat/lon to address\\)\n  const reverseGeocode = async \\(lat, lon\\) => {\n    try {\n      // Using Nominatim \\(free, no API key needed\\)\n      const response = await fetch\\(\n        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=vi`\n      \\);\n      const data = await response.json\\(\\);\n      return data.display_name || 'Kh√¥ng x√°c ƒë·ªãnh';\n    } catch \\(err\\) {\n      console.error\\('Error reverse geocoding:', err\\);\n      return 'Kh√¥ng x√°c ƒë·ªãnh';\n    }\n  };\n\n  // Calculate distance between two points \\(Haversine formula\\)\n  const calculateDistance = \\(lat1, lon1, lat2, lon2\\) => {\n    const R = 6371; // Earth radius in km\n    const dLat = \\(\\(lat2 - lat1\\) * Math.PI\\) / 180;\n    const dLon = \\(\\(lon2 - lon1\\) * Math.PI\\) / 180;\n    const a =\n      Math.sin\\(dLat / 2\\) * Math.sin\\(dLat / 2\\) +\n      Math.cos\\(\\(lat1 * Math.PI\\) / 180\\) *\n        Math.cos\\(\\(lat2 * Math.PI\\) / 180\\) *\n        Math.sin\\(dLon / 2\\) *\n        Math.sin\\(dLon / 2\\);\n    const c = 2 * Math.atan2\\(Math.sqrt\\(a\\), Math.sqrt\\(1 - a\\)\\);\n    return R * c;\n  };\n\n  // Check if user is near any danger zone\n  const checkNearbyDangers = async \\(userLat, userLon, alertRadius = 1.0\\) => {\n    const nearby = await getNearbyDangers\\(userLat, userLon, alertRadius\\);\n    return nearby.length > 0 ? nearby : null;\n  };\n\n  // Subscribe to realtime updates\n  useEffect\\(\\(\\) => {\n    const channel = supabase\n      .channel\\('danger_zones_changes'\\)\n      .on\\(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'danger_zones',\n          filter: 'status=eq.approved',\n        },\n        \\(payload\\) => {\n          setDangerZones\\(\\(prev\\) => [...prev, payload.new]\\);\n        }\n      \\)\n      .on\\(\n        'postgres_changes',\n        {\n          event: 'UPDATE',\n          schema: 'public',\n          table: 'danger_zones',\n        },\n        \\(payload\\) => {\n          if \\(payload.new.status === 'approved'\\) {\n            setDangerZones\\(\\(prev\\) =>\n              prev.map\\(\\(zone\\) =>\n                zone.id === payload.new.id ? payload.new : zone\n              \\)\n            \\);\n          }\n        }\n      \\)\n      .subscribe\\(\\);\n\n    return \\(\\) => {\n      supabase.removeChannel\\(channel\\);\n    };\n  }, []\\);\n\n  return {\n    dangerZones,\n    userLocation,\n    loading,\n    error,\n    fetchDangerZones,\n    getNearbyDangers,\n    addDangerZone,\n    getCurrentLocation,\n    reverseGeocode,\n    calculateDistance,\n    checkNearbyDangers,\n  };\n};\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/pages/Community.jsx << 'EOF'\nimport React, { useEffect, useState } from 'react';\nimport { Page, Header, Box, Text, Button, Input, Sheet, useSnackbar } from 'zmp-ui';\nimport { useCommunity } from '../services/useCommunity';\nimport { useCloudinary } from '../utils/useCloudinary';\nimport CommunityBubble from '../components/CommunityBubble';\n\nconst CommunityPage = \\(\\) => {\n  const { posts, loading, fetchPosts, createPost } = useCommunity\\(\\);\n  const { uploadImage } = useCloudinary\\(\\);\n  const { openSnackbar } = useSnackbar\\(\\);\n  \n  const [showCreateSheet, setShowCreateSheet] = useState\\(false\\);\n  const [newPost, setNewPost] = useState\\({\n    content: '',\n    image: null,\n    isAnonymous: false,\n  }\\);\n  const [uploading, setUploading] = useState\\(false\\);\n\n  useEffect\\(\\(\\) => {\n    fetchPosts\\(\\);\n  }, []\\);\n\n  const handleImageSelect = async \\(e\\) => {\n    const file = e.target.files?.[0];\n    if \\(!file\\) return;\n\n    setUploading\\(true\\);\n    try {\n      const result = await uploadImage\\(file\\);\n      if \\(result\\) {\n        setNewPost\\(\\(prev\\) => \\({ ...prev, image: result.secure_url }\\)\\);\n        openSnackbar\\({ text: 'T·∫£i ·∫£nh th√†nh c√¥ng!', type: 'success' }\\);\n      }\n    } catch \\(error\\) {\n      openSnackbar\\({ text: 'L·ªói t·∫£i ·∫£nh', type: 'error' }\\);\n    } finally {\n      setUploading\\(false\\);\n    }\n  };\n\n  const handleSubmitPost = async \\(\\) => {\n    if \\(!newPost.content.trim\\(\\)\\) {\n      openSnackbar\\({ text: 'Vui l√≤ng nh·∫≠p n·ªôi dung', type: 'warning' }\\);\n      return;\n    }\n\n    setUploading\\(true\\);\n    try {\n      const result = await createPost\\({\n        content: newPost.content,\n        image_url: newPost.image,\n        is_anonymous: newPost.isAnonymous,\n      }\\);\n\n      if \\(result\\) {\n        openSnackbar\\({ \n          text: 'ƒêƒÉng b√†i th√†nh c√¥ng! ƒêang ch·ªù duy·ªát.', \n          type: 'success' \n        }\\);\n        setNewPost\\({ content: '', image: null, isAnonymous: false }\\);\n        setShowCreateSheet\\(false\\);\n      } else {\n        openSnackbar\\({ text: 'Kh√¥ng th·ªÉ ƒëƒÉng b√†i', type: 'error' }\\);\n      }\n    } catch \\(error\\) {\n      openSnackbar\\({ text: 'C√≥ l·ªói x·∫£y ra', type: 'error' }\\);\n    } finally {\n      setUploading\\(false\\);\n    }\n  };\n\n  return \\(\n    <Page className=\"page\">\n      <Header title=\"C·ªông ƒë·ªìng\" showBackIcon={false} />\n\n      <Box p={4}>\n        <Box className=\"bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-xl mb-4\">\n          <Text.Title className=\"text-white mb-2\">\n            üí¨ Chia s·∫ª kinh nghi·ªám\n          </Text.Title>\n          <Text className=\"text-white text-sm mb-3\">\n            K·∫øt n·ªëi v·ªõi c·ªông ƒë·ªìng y√™u th√∫ c∆∞ng, chia s·∫ª c√¢u chuy·ªán v√† h·ªçc h·ªèi kinh nghi·ªám\n          </Text>\n          <Button \n            size=\"small\" \n            type=\"primary\"\n            onClick={\\(\\) => setShowCreateSheet\\(true\\)}\n          >\n            ‚úçÔ∏è ƒêƒÉng b√†i m·ªõi\n          </Button>\n        </Box>\n\n        {loading && posts.length === 0 ? \\(\n          <Box className=\"text-center py-8\">\n            <Text className=\"text-gray-500\">ƒêang t·∫£i...</Text>\n          </Box>\n        \\) : posts.length === 0 ? \\(\n          <Box className=\"text-center py-8 bg-gray-100 rounded-xl\">\n            <Text className=\"text-gray-600 mb-2\">\n              Ch∆∞a c√≥ b√†i vi·∫øt n√†o\n            </Text>\n            <Text className=\"text-sm text-gray-500\">\n              H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª!\n            </Text>\n          </Box>\n        \\) : \\(\n          <Box className=\"space-y-3\">\n            {posts.map\\(\\(post\\) => \\(\n              <CommunityBubble key={post.id} post={post} />\n            \\)\\)}\n          </Box>\n        \\)}\n      </Box>\n\n      {/* Create Post Sheet */}\n      <Sheet\n        visible={showCreateSheet}\n        onClose={\\(\\) => setShowCreateSheet\\(false\\)}\n        autoHeight\n        title=\"ƒêƒÉng b√†i m·ªõi\"\n      >\n        <Box p={4} className=\"space-y-4\">\n          <Box>\n            <Text className=\"text-sm font-bold mb-2\">N·ªôi dung</Text>\n            <textarea\n              placeholder=\"Chia s·∫ª kinh nghi·ªám, c√¢u chuy·ªán c·ªßa b·∫°n...\"\n              value={newPost.content}\n              onChange={\\(e\\) =>\n                setNewPost\\(\\(prev\\) => \\({ ...prev, content: e.target.value }\\)\\)\n              }\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n              rows={5}\n              maxLength={500}\n            />\n            <Text className=\"text-xs text-gray-500 mt-1\">\n              {newPost.content.length}/500 k√Ω t·ª±\n            </Text>\n          </Box>\n\n          <Box>\n            <Text className=\"text-sm font-bold mb-2\">·∫¢nh \\(t√πy ch·ªçn\\)</Text>\n            <input\n              type=\"file\"\n              accept=\"image/*\"\n              onChange={handleImageSelect}\n              disabled={uploading}\n              className=\"w-full\"\n            />\n            {newPost.image && \\(\n              <Box className=\"mt-2\">\n                <img\n                  src={newPost.image}\n                  alt=\"Preview\"\n                  className=\"w-full h-40 object-cover rounded-lg\"\n                />\n              </Box>\n            \\)}\n          </Box>\n\n          <Box className=\"flex items-center\">\n            <input\n              type=\"checkbox\"\n              checked={newPost.isAnonymous}\n              onChange={\\(e\\) =>\n                setNewPost\\(\\(prev\\) => \\({ ...prev, isAnonymous: e.target.checked }\\)\\)\n              }\n              className=\"mr-2\"\n            />\n            <Text className=\"text-sm\">ƒêƒÉng ·∫©n danh</Text>\n          </Box>\n\n          <Box className=\"flex gap-2\">\n            <Button\n              fullWidth\n              type=\"secondary\"\n              onClick={\\(\\) => setShowCreateSheet\\(false\\)}\n              disabled={uploading}\n            >\n              H·ªßy\n            </Button>\n            <Button\n              fullWidth\n              type=\"primary\"\n              onClick={handleSubmitPost}\n              disabled={uploading || !newPost.content.trim\\(\\)}\n            >\n              {uploading ? 'ƒêang ƒëƒÉng...' : 'ƒêƒÉng b√†i'}\n            </Button>\n          </Box>\n\n          <Text className=\"text-xs text-gray-500 text-center\">\n            ‚ö†Ô∏è B√†i vi·∫øt s·∫Ω ƒë∆∞·ª£c ki·ªÉm duy·ªát tr∆∞·ªõc khi hi·ªÉn th·ªã\n          </Text>\n        </Box>\n      </Sheet>\n    </Page>\n  \\);\n};\n\nexport default CommunityPage;\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/components/CommunityBubble.jsx << 'EOF'\nimport React, { useState } from 'react';\nimport { Box, Text, Button, Avatar, Sheet, Input } from 'zmp-ui';\nimport { useCommunity } from '../services/useCommunity';\n\nconst CommunityBubble = \\({ post }\\) => {\n  const { getComments, addComment, likePost } = useCommunity\\(\\);\n  const [showComments, setShowComments] = useState\\(false\\);\n  const [comments, setComments] = useState\\([]\\);\n  const [newComment, setNewComment] = useState\\(''\\);\n  const [loadingComments, setLoadingComments] = useState\\(false\\);\n  const [liked, setLiked] = useState\\(false\\);\n\n  const handleShowComments = async \\(\\) => {\n    if \\(!showComments\\) {\n      setLoadingComments\\(true\\);\n      const fetchedComments = await getComments\\(post.id\\);\n      setComments\\(fetchedComments\\);\n      setLoadingComments\\(false\\);\n    }\n    setShowComments\\(!showComments\\);\n  };\n\n  const handleAddComment = async \\(\\) => {\n    if \\(!newComment.trim\\(\\)\\) return;\n\n    const comment = await addComment\\(post.id, newComment\\);\n    if \\(comment\\) {\n      setComments\\(\\(prev\\) => [...prev, comment]\\);\n      setNewComment\\(''\\);\n    }\n  };\n\n  const handleLike = async \\(\\) => {\n    if \\(!liked\\) {\n      await likePost\\(post.id\\);\n      setLiked\\(true\\);\n    }\n  };\n\n  const formatDate = \\(dateString\\) => {\n    const date = new Date\\(dateString\\);\n    const now = new Date\\(\\);\n    const diffMs = now - date;\n    const diffMins = Math.floor\\(diffMs / 60000\\);\n    const diffHours = Math.floor\\(diffMs / 3600000\\);\n    const diffDays = Math.floor\\(diffMs / 86400000\\);\n\n    if \\(diffMins < 1\\) return 'V·ª´a xong';\n    if \\(diffMins < 60\\) return `${diffMins} ph√∫t tr∆∞·ªõc`;\n    if \\(diffHours < 24\\) return `${diffHours} gi·ªù tr∆∞·ªõc`;\n    if \\(diffDays < 7\\) return `${diffDays} ng√†y tr∆∞·ªõc`;\n    return date.toLocaleDateString\\('vi-VN'\\);\n  };\n\n  return \\(\n    <Box className=\"bg-white rounded-xl shadow-sm p-4 border border-gray-100\">\n      {/* Header */}\n      <Box className=\"flex items-center mb-3\">\n        <Avatar\n          src={post.is_anonymous ? '' : post.profiles?.avatar}\n          size={40}\n        />\n        <Box className=\"ml-3 flex-1\">\n          <Text className=\"font-bold\">\n            {post.is_anonymous ? '·∫®n danh' : post.profiles?.name || 'Ng∆∞·ªùi d√πng'}\n          </Text>\n          <Text className=\"text-xs text-gray-500\">\n            {formatDate\\(post.created_at\\)}\n          </Text>\n        </Box>\n      </Box>\n\n      {/* Content */}\n      <Text className=\"mb-3 whitespace-pre-wrap\">{post.content}</Text>\n\n      {/* Image */}\n      {post.image_url && \\(\n        <Box className=\"mb-3\">\n          <img\n            src={post.image_url}\n            alt=\"Post\"\n            className=\"w-full rounded-lg max-h-80 object-cover\"\n          />\n        </Box>\n      \\)}\n\n      {/* Actions */}\n      <Box className=\"flex items-center gap-4 pt-3 border-t border-gray-100\">\n        <Button\n          size=\"small\"\n          type=\"neutral\"\n          onClick={handleLike}\n          disabled={liked}\n        >\n          {liked ? '‚ù§Ô∏è' : 'ü§ç'} {post.likes_count + \\(liked ? 1 : 0\\)}\n        </Button>\n        <Button size=\"small\" type=\"neutral\" onClick={handleShowComments}>\n          üí¨ {post.comments_count}\n        </Button>\n      </Box>\n\n      {/* Comments Sheet */}\n      <Sheet\n        visible={showComments}\n        onClose={\\(\\) => setShowComments\\(false\\)}\n        autoHeight\n        title=\"B√¨nh lu·∫≠n\"\n      >\n        <Box p={4}>\n          {loadingComments ? \\(\n            <Text className=\"text-center text-gray-500\">ƒêang t·∫£i...</Text>\n          \\) : comments.length === 0 ? \\(\n            <Text className=\"text-center text-gray-500 mb-4\">\n              Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o\n            </Text>\n          \\) : \\(\n            <Box className=\"space-y-3 mb-4 max-h-96 overflow-y-auto\">\n              {comments.map\\(\\(comment\\) => \\(\n                <Box key={comment.id} className=\"flex gap-2\">\n                  <Avatar\n                    src={comment.is_anonymous ? '' : comment.profiles?.avatar}\n                    size={32}\n                  />\n                  <Box className=\"flex-1 bg-gray-100 rounded-lg p-2\">\n                    <Text className=\"font-bold text-sm\">\n                      {comment.is_anonymous\n                        ? '·∫®n danh'\n                        : comment.profiles?.name || 'Ng∆∞·ªùi d√πng'}\n                    </Text>\n                    <Text className=\"text-sm\">{comment.content}</Text>\n                    <Text className=\"text-xs text-gray-500 mt-1\">\n                      {formatDate\\(comment.created_at\\)}\n                    </Text>\n                  </Box>\n                </Box>\n              \\)\\)}\n            </Box>\n          \\)}\n\n          {/* Add Comment */}\n          <Box className=\"flex gap-2\">\n            <Input\n              placeholder=\"Vi·∫øt b√¨nh lu·∫≠n...\"\n              value={newComment}\n              onChange={\\(e\\) => setNewComment\\(e.target.value\\)}\n              className=\"flex-1\"\n            />\n            <Button\n              size=\"small\"\n              onClick={handleAddComment}\n              disabled={!newComment.trim\\(\\)}\n            >\n              G·ª≠i\n            </Button>\n          </Box>\n        </Box>\n      </Sheet>\n    </Box>\n  \\);\n};\n\nexport default CommunityBubble;\nEOF)",
      "Bash(/d/Pet Is My Family/pet_is_my_family/zalo_mini_app/src/pages/DangerZone.jsx << 'EOF'\nimport React, { useEffect, useState } from 'react';\nimport { Page, Header, Box, Text, Button, Sheet, Select, Input, useSnackbar } from 'zmp-ui';\nimport { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';\nimport L from 'leaflet';\nimport 'leaflet/dist/leaflet.css';\nimport { useMap as useDangerMap } from '../services/useMap';\nimport { useCloudinary } from '../utils/useCloudinary';\nimport DangerPinMarker from '../components/DangerPinMarker';\n\n// Fix Leaflet default icon issue\ndelete L.Icon.Default.prototype._getIconUrl;\nL.Icon.Default.mergeOptions\\({\n  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',\n  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',\n  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',\n}\\);\n\nconst { Option } = Select;\n\nconst DangerZonePage = \\(\\) => {\n  const {\n    dangerZones,\n    userLocation,\n    loading,\n    fetchDangerZones,\n    addDangerZone,\n    getCurrentLocation,\n    reverseGeocode,\n    checkNearbyDangers,\n  } = useDangerMap\\(\\);\n\n  const { uploadImage } = useCloudinary\\(\\);\n  const { openSnackbar } = useSnackbar\\(\\);\n\n  const [showAddSheet, setShowAddSheet] = useState\\(false\\);\n  const [newZone, setNewZone] = useState\\({\n    lat: null,\n    lon: null,\n    type: 'poison',\n    description: '',\n    image: null,\n  }\\);\n  const [address, setAddress] = useState\\(''\\);\n  const [uploading, setUploading] = useState\\(false\\);\n  const [mapCenter, setMapCenter] = useState\\([21.0285, 105.8542]\\); // Hanoi default\n\n  useEffect\\(\\(\\) => {\n    fetchDangerZones\\(\\);\n    initLocation\\(\\);\n  }, []\\);\n\n  const initLocation = async \\(\\) => {\n    try {\n      const location = await getCurrentLocation\\(\\);\n      setMapCenter\\([location.lat, location.lon]\\);\n      \n      // Check for nearby dangers\n      const nearby = await checkNearbyDangers\\(location.lat, location.lon, 1.0\\);\n      if \\(nearby && nearby.length > 0\\) {\n        openSnackbar\\({\n          text: `‚ö†Ô∏è C·∫£nh b√°o: C√≥ ${nearby.length} khu v·ª±c nguy hi·ªÉm g·∫ßn b·∫°n!`,\n          type: 'warning',\n          duration: 5000,\n        }\\);\n      }\n    } catch \\(error\\) {\n      console.error\\('Error getting location:', error\\);\n    }\n  };\n\n  const handleMapClick = async \\(e\\) => {\n    const { lat, lng } = e.latlng;\n    setNewZone\\(\\(prev\\) => \\({ ...prev, lat, lon: lng }\\)\\);\n    \n    // Get address\n    const addr = await reverseGeocode\\(lat, lng\\);\n    setAddress\\(addr\\);\n    \n    setShowAddSheet\\(true\\);\n  };\n\n  const handleImageSelect = async \\(e\\) => {\n    const file = e.target.files?.[0];\n    if \\(!file\\) return;\n\n    setUploading\\(true\\);\n    try {\n      const result = await uploadImage\\(file\\);\n      if \\(result\\) {\n        setNewZone\\(\\(prev\\) => \\({ ...prev, image: result.secure_url }\\)\\);\n        openSnackbar\\({ text: 'T·∫£i ·∫£nh th√†nh c√¥ng!', type: 'success' }\\);\n      }\n    } catch \\(error\\) {\n      openSnackbar\\({ text: 'L·ªói t·∫£i ·∫£nh', type: 'error' }\\);\n    } finally {\n      setUploading\\(false\\);\n    }\n  };\n\n  const handleSubmitZone = async \\(\\) => {\n    if \\(!newZone.lat || !newZone.lon\\) {\n      openSnackbar\\({ text: 'Vui l√≤ng ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì', type: 'warning' }\\);\n      return;\n    }\n\n    if \\(!newZone.description.trim\\(\\)\\) {\n      openSnackbar\\({ text: 'Vui l√≤ng nh·∫≠p m√¥ t·∫£', type: 'warning' }\\);\n      return;\n    }\n\n    setUploading\\(true\\);\n    try {\n      const result = await addDangerZone\\({\n        lat: newZone.lat,\n        lon: newZone.lon,\n        type: newZone.type,\n        description: newZone.description,\n        image_url: newZone.image,\n      }\\);\n\n      if \\(result\\) {\n        openSnackbar\\({\n          text: 'ƒê√£ g·ª≠i c·∫£nh b√°o! ƒêang ch·ªù duy·ªát.',\n          type: 'success',\n        }\\);\n        setNewZone\\({ lat: null, lon: null, type: 'poison', description: '', image: null }\\);\n        setShowAddSheet\\(false\\);\n      } else {\n        openSnackbar\\({ text: 'Kh√¥ng th·ªÉ th√™m c·∫£nh b√°o', type: 'error' }\\);\n      }\n    } catch \\(error\\) {\n      openSnackbar\\({ text: 'C√≥ l·ªói x·∫£y ra', type: 'error' }\\);\n    } finally {\n      setUploading\\(false\\);\n    }\n  };\n\n  return \\(\n    <Page className=\"page\">\n      <Header title=\"B·∫£n ƒë·ªì nguy hi·ªÉm\" showBackIcon={false} />\n\n      <Box className=\"relative h-screen\">\n        {/* Map */}\n        <MapContainer\n          center={mapCenter}\n          zoom={13}\n          style={{ height: '100%', width: '100%' }}\n          onClick={handleMapClick}\n        >\n          <TileLayer\n            attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a>'\n            url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n          />\n\n          {/* User location */}\n          {userLocation && \\(\n            <Marker position={[userLocation.lat, userLocation.lon]}>\n              <Popup>üìç V·ªã tr√≠ c·ªßa b·∫°n</Popup>\n            </Marker>\n          \\)}\n\n          {/* Danger zones */}\n          {dangerZones.map\\(\\(zone\\) => \\(\n            <DangerPinMarker key={zone.id} zone={zone} />\n          \\)\\)}\n        </MapContainer>\n\n        {/* Legend */}\n        <Box className=\"absolute top-4 right-4 bg-white rounded-lg shadow-lg p-3 z-1000\">\n          <Text className=\"font-bold text-sm mb-2\">Ch√∫ th√≠ch</Text>\n          <Box className=\"space-y-1\">\n            <Box className=\"flex items-center gap-2\">\n              <Box className=\"w-4 h-4 bg-red-500 rounded-full\"></Box>\n              <Text className=\"text-xs\">B·∫£ ƒë·ªôc</Text>\n            </Box>\n            <Box className=\"flex items-center gap-2\">\n              <Box className=\"w-4 h-4 bg-orange-500 rounded-full\"></Box>\n              <Text className=\"text-xs\">Tr·ªôm ch√≥/m√®o</Text>\n            </Box>\n            <Box className=\"flex items-center gap-2\">\n              <Box className=\"w-4 h-4 bg-yellow-500 rounded-full\"></Box>\n              <Text className=\"text-xs\">Nguy hi·ªÉm kh√°c</Text>\n            </Box>\n          </Box>\n        </Box>\n\n        {/* FAB Add Button */}\n        <Button\n          className=\"absolute bottom-20 right-4 z-1000 rounded-full w-14 h-14 shadow-lg\"\n          type=\"primary\"\n          onClick={\\(\\) => {\n            if \\(userLocation\\) {\n              setNewZone\\(\\(prev\\) => \\({ ...prev, lat: userLocation.lat, lon: userLocation.lon }\\)\\);\n              setShowAddSheet\\(true\\);\n            } else {\n              openSnackbar\\({ text: 'ƒêang l·∫•y v·ªã tr√≠...', type: 'warning' }\\);\n            }\n          }}\n        >\n          ‚ûï\n        </Button>\n\n        {/* Info Box */}\n        <Box className=\"absolute bottom-4 left-4 right-4 bg-white rounded-lg shadow-lg p-3 z-1000\">\n          <Text className=\"text-sm font-bold mb-1\">\n            üí° H∆∞·ªõng d·∫´n\n          </Text>\n          <Text className=\"text-xs text-gray-600\">\n            Nh·∫•n v√†o b·∫£n ƒë·ªì ƒë·ªÉ ƒë√°nh d·∫•u khu v·ª±c nguy hi·ªÉm. Gi√∫p c·ªông ƒë·ªìng c·∫£nh b√°o b·∫£ ƒë·ªôc v√† tr·ªôm c·∫Øp!\n          </Text>\n        </Box>\n      </Box>\n\n      {/* Add Zone Sheet */}\n      <Sheet\n        visible={showAddSheet}\n        onClose={\\(\\) => setShowAddSheet\\(false\\)}\n        autoHeight\n        title=\"Th√™m c·∫£nh b√°o\"\n      >\n        <Box p={4} className=\"space-y-4\">\n          <Box>\n            <Text className=\"text-sm font-bold mb-2\">V·ªã tr√≠</Text>\n            <Text className=\"text-xs text-gray-600\">{address || 'ƒêang t·∫£i...'}</Text>\n          </Box>\n\n          <Box>\n            <Text className=\"text-sm font-bold mb-2\">Lo·∫°i c·∫£nh b√°o</Text>\n            <Select\n              value={newZone.type}\n              onChange={\\(value\\) => setNewZone\\(\\(prev\\) => \\({ ...prev, type: value }\\)\\)}\n            >\n              <Option value=\"poison\" title=\"‚ò†Ô∏è B·∫£ ƒë·ªôc\" />\n              <Option value=\"thief\" title=\"üö® Tr·ªôm ch√≥/m√®o\" />\n              <Option value=\"danger\" title=\"‚ö†Ô∏è Nguy hi·ªÉm kh√°c\" />\n            </Select>\n          </Box>\n\n          <Box>\n            <Text className=\"text-sm font-bold mb-2\">M√¥ t·∫£ chi ti·∫øt</Text>\n            <textarea\n              placeholder=\"M√¥ t·∫£ t√¨nh hu·ªëng, th·ªùi gian ph√°t hi·ªán...\"\n              value={newZone.description}\n              onChange={\\(e\\) =>\n                setNewZone\\(\\(prev\\) => \\({ ...prev, description: e.target.value }\\)\\)\n              }\n              className=\"w-full p-3 border border-gray-300 rounded-lg\"\n              rows={4}\n              maxLength={300}\n            />\n            <Text className=\"text-xs text-gray-500 mt-1\">\n              {newZone.description.length}/300 k√Ω t·ª±\n            </Text>\n          </Box>\n\n          <Box>\n            <Text className=\"text-sm font-bold mb-2\">·∫¢nh minh ch·ª©ng \\(t√πy ch·ªçn\\)</Text>\n            <input\n              type=\"file\"\n              accept=\"image/*\"\n              onChange={handleImageSelect}\n              disabled={uploading}\n              className=\"w-full\"\n            />\n            {newZone.image && \\(\n              <Box className=\"mt-2\">\n                <img\n                  src={newZone.image}\n                  alt=\"Preview\"\n                  className=\"w-full h-40 object-cover rounded-lg\"\n                />\n              </Box>\n            \\)}\n          </Box>\n\n          <Box className=\"flex gap-2\">\n            <Button\n              fullWidth\n              type=\"secondary\"\n              onClick={\\(\\) => setShowAddSheet\\(false\\)}\n              disabled={uploading}\n            >\n              H·ªßy\n            </Button>\n            <Button\n              fullWidth\n              type=\"danger\"\n              onClick={handleSubmitZone}\n              disabled={uploading || !newZone.description.trim\\(\\)}\n            >\n              {uploading ? 'ƒêang g·ª≠i...' : '‚ö†Ô∏è G·ª≠i c·∫£nh b√°o'}\n            </Button>\n          </Box>\n\n          <Text className=\"text-xs text-gray-500 text-center\">\n            C·∫£nh b√°o s·∫Ω ƒë∆∞·ª£c ki·ªÉm duy·ªát tr∆∞·ªõc khi hi·ªÉn th·ªã\n          </Text>\n        </Box>\n      </Sheet>\n    </Page>\n  \\);\n};\n\nexport default DangerZonePage;\nEOF)"
    ]
  }
}
